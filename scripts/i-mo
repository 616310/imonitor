#!/usr/bin/env bash
set -euo pipefail

# Simple CLI entrypoint: i-mo
# Manages controller (imonitor-lite) or agent (imonitor-agent) depending on what's installed.

SERVICE_CTRL="imonitor-lite"
SERVICE_AGENT="imonitor-agent"
CTRL_UNIT="/etc/systemd/system/${SERVICE_CTRL}.service"
AGENT_ENV="/opt/imonitor-agent/agent.env"

require_root() {
  if [[ "$EUID" -ne 0 ]]; then
    echo "请使用 root 权限运行 (sudo i-mo)" >&2
    exit 1
  fi
}

has_service() {
  systemctl list-unit-files | grep -q "^${1}.service"
}

prompt() {
  local msg="$1" default="$2" var
  read -r -p "$msg [$default]: " var
  echo "${var:-$default}"
}

line_in_file() {
  local pattern="$1" file="$2" replacement="$3"
  if grep -q "^${pattern}" "$file"; then
    sed -i "s?^${pattern}.*?${replacement}?" "$file"
  else
    echo "$replacement" >>"$file"
  fi
}

ctrl_status() {
  systemctl status "$SERVICE_CTRL" --no-pager
}

ctrl_logs() {
  journalctl -u "$SERVICE_CTRL" -n 50 --no-pager
}

ctrl_reload() {
  systemctl daemon-reload
  systemctl restart "$SERVICE_CTRL"
  systemctl status "$SERVICE_CTRL" --no-pager | head -n 5
}

ctrl_edit_settings() {
  local port host public bind admin_user admin_pass
  require_root
  if [[ ! -f "$CTRL_UNIT" ]]; then
    echo "未找到 $CTRL_UNIT" >&2
    return
  fi
  port=$(grep -o "IMONITOR_BIND=.*:" "$CTRL_UNIT" | head -n1 | sed 's/.*://;s/]//;s/\"//g')
  port=${port:-8080}
  host=$(grep -o "IMONITOR_PUBLIC_URL=.*" "$CTRL_UNIT" | head -n1 | sed 's/.*=//;s/\"//g')
  admin_user=$(grep -o "IMONITOR_ADMIN_USER=.*" "$CTRL_UNIT" | head -n1 | sed 's/.*=//;s/\"//g')
  admin_pass=$(grep -o "IMONITOR_ADMIN_PASS=.*" "$CTRL_UNIT" | head -n1 | sed 's/.*=//;s/\"//g')

  port=$(prompt "新的服务端口" "$port")
  host=$(prompt "新的公共地址（含协议）" "$host")
  admin_user=$(prompt "管理员用户名" "${admin_user:-admin}")
  read -r -s -p "管理员密码 (回车保留当前): " input_pass; echo
  if [[ -n "$input_pass" ]]; then
    admin_pass="$input_pass"
  fi
  bind="[::]:${port}"

  sed -i "s?^Environment=IMONITOR_BIND=.*?Environment=IMONITOR_BIND=${bind}?g" "$CTRL_UNIT"
  sed -i "s?^Environment=IMONITOR_PUBLIC_URL=.*?Environment=IMONITOR_PUBLIC_URL=${host}?g" "$CTRL_UNIT"
  line_in_file "Environment=IMONITOR_ADMIN_USER" "$CTRL_UNIT" "Environment=IMONITOR_ADMIN_USER=${admin_user}"
  line_in_file "Environment=IMONITOR_ADMIN_PASS" "$CTRL_UNIT" "Environment=IMONITOR_ADMIN_PASS=${admin_pass}"

  echo "已更新配置，正在重启..."
  ctrl_reload
}

agent_status() {
  systemctl status "$SERVICE_AGENT" --no-pager
}

agent_logs() {
  journalctl -u "$SERVICE_AGENT" -n 50 --no-pager
}

agent_edit_env() {
  require_root
  if [[ ! -f "$AGENT_ENV" ]]; then
    echo "未找到 $AGENT_ENV" >&2
    return
  fi
  local token endpoint interval flag
  token=$(grep "^IMONITOR_TOKEN" "$AGENT_ENV" | cut -d= -f2-)
  endpoint=$(grep "^IMONITOR_ENDPOINT" "$AGENT_ENV" | cut -d= -f2-)
  interval=$(grep "^IMONITOR_INTERVAL" "$AGENT_ENV" | cut -d= -f2-)
  flag=$(grep "^IMONITOR_FLAG" "$AGENT_ENV" | cut -d= -f2-)

  token=$(prompt "Token" "$token")
  endpoint=$(prompt "Endpoint" "$endpoint")
  interval=$(prompt "上报间隔(秒)" "$interval")
  flag=$(prompt "标识 Emoji" "$flag")

  cat >"$AGENT_ENV" <<EOF
IMONITOR_TOKEN=$token
IMONITOR_ENDPOINT=$endpoint
IMONITOR_INTERVAL=$interval
IMONITOR_FLAG=$flag
EOF

  systemctl restart "$SERVICE_AGENT"
  agent_status | head -n 5
}

choose_role() {
  if has_service "$SERVICE_CTRL"; then echo "server"; return; fi
  if has_service "$SERVICE_AGENT"; then echo "agent"; return; fi
  echo "unknown"
}

server_menu() {
  while true; do
    cat <<'MENU'
[i-mo] 请选择操作:
 1) 查看状态
 2) 查看最近日志
 3) 重启服务
 4) 修改端口/公共地址/管理员账号
 5) 退出
MENU
    read -r -p "> " sel
    case "$sel" in
      1) ctrl_status ;;
      2) ctrl_logs ;;
      3) ctrl_reload ;;
      4) ctrl_edit_settings ;;
      5) exit 0 ;;
    esac
  done
}

agent_menu() {
  while true; do
    cat <<'MENU'
[i-mo] 请选择操作:
 1) 查看状态
 2) 查看最近日志
 3) 重启服务
 4) 修改 token/endpoint/间隔/flag
 5) 退出
MENU
    read -r -p "> " sel
    case "$sel" in
      1) agent_status ;;
      2) agent_logs ;;
      3) systemctl restart "$SERVICE_AGENT" && agent_status | head -n 5 ;;
      4) agent_edit_env ;;
      5) exit 0 ;;
    esac
  done
}

main() {
  role=$(choose_role)
  case "$role" in
    server) server_menu ;;
    agent) agent_menu ;;
    *)
      echo "未检测到 imonitor-lite 或 imonitor-agent 的 systemd 服务，请在部署后使用。" >&2
      exit 1
      ;;
  esac
}

main "$@"
